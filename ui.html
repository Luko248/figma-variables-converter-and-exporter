<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Figma Design Tokens Manager</title>
    <style>
        :root {
            --bg: #ffffff;
            --text: #0b0b0b;
            --muted: #8c8c8c;
            --panel: #f8f8f8;
            --panel-strong: #ffffff;
            --border: #e6e6e6;
            --accent: #6bd9a5;
            --accent-strong: #55c48f;
            --accent-stronger: #3ea876;
            --success-bg: #e8f7ed;
            --success-text: #0d5520;
            --success-border: #a7e5b8;
            --error-bg: #ffeaea;
            --error-text: #cc1e1e;
            --error-border: #ffb3b3;
            --info-bg: #e6f6ed;
            --info-text: #1f6b4d;
            --info-border: #b7e7cf;
        }

        [data-theme="dark"] {
            --bg: #0f1115;
            --text: #f5f7fb;
            --muted: #9aa4b5;
            --panel: #181b21;
            --panel-strong: #1f242c;
            --border: #2b303a;
            --accent: #7fe7b7;
            --accent-strong: #5fcd9c;
            --accent-stronger: #4ab386;
            --success-bg: #12301c;
            --success-text: #b4f1c7;
            --success-border: #2d5f3b;
            --error-bg: #3a1b1b;
            --error-text: #ffb3b3;
            --error-border: #663939;
            --info-bg: #123328;
            --info-text: #b9f5d4;
            --info-border: #2c5f48;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            font-size: 12px;
            line-height: 1.4;
            min-width: 390px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .header h1 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text);
        }

        .header p {
            font-size: 11px;
            color: var(--muted);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon-button {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--panel-strong);
            color: var(--text);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .icon-button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .icon-button:active {
            transform: translateY(1px);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--panel);
            padding: 12px 16px;
            gap: 8px;
        }

        .tab {
            flex: 1;
            padding: 10px 12px;
            text-align: left;
            cursor: pointer;
            border: none;
            background: var(--panel-strong);
            font-size: 11px;
            font-weight: 500;
            color: var(--muted);
            transition: all 0.2s ease;
            border-radius: 8px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .tab::before {
            content: attr(data-step);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--border);
            color: var(--muted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .tab:hover {
            background: var(--panel);
            border-color: var(--accent);
            color: var(--text);
        }

        .tab.active {
            background: var(--bg);
            color: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(107, 217, 165, 0.2);
        }

        .tab.active::before {
            background: var(--accent);
            color: #0f2e1c;
            border: 1px solid var(--accent-stronger);
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 100px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .section {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--panel);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .section h2 {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text);
        }

        .button {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .button:last-child {
            margin-bottom: 0;
        }

        .button-primary {
            background: var(--accent);
            color: #ffffff;
        }

        .button-primary:hover {
            background: var(--accent-strong);
        }

        .button-primary:active {
            background: var(--accent-stronger);
        }

        .button-secondary {
            background: var(--panel-strong);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .button-secondary:hover {
            background: var(--panel);
            border-color: var(--accent);
        }

        .button-secondary:active {
            background: var(--panel-strong);
        }

        .button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .status {
            padding: 12px;
            font-size: 11px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }

        .status-success {
            background: var(--success-bg);
            color: var(--success-text);
            border: 1px solid var(--success-border);
        }

        .status-error {
            background: var(--error-bg);
            color: var(--error-text);
            border: 1px solid var(--error-border);
        }

        .status-info {
            background: var(--info-bg);
            color: var(--info-text);
            border: 1px solid var(--info-border);
        }

        .info-message {
            padding: 8px;
            background: var(--info-bg);
            border: 1px solid var(--info-border);
            border-radius: 4px;
            font-size: 10px;
            color: var(--info-text);
            text-align: center;
            margin-top: 8px;
        }

        .variables-count {
            text-align: center;
            font-size: 11px;
            color: var(--muted);
            margin: 12px 0;
        }

        .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #e6e6e6;
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .collections-container, .variables-container {
            min-height: 120px;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            background: var(--panel-strong);
        }

        .collection-item, .variable-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: all 0.2s ease;
        }

        .collection-item:hover, .variable-item:hover {
            background: var(--panel);
        }

        .collection-item.selected, .variable-item.selected {
            background: var(--info-bg);
            border: 1px solid var(--info-border);
        }

        .collection-name, .variable-name {
            font-weight: 500;
            font-size: 11px;
        }

        .collection-meta, .variable-meta {
            font-size: 10px;
            color: #8c8c8c;
        }

        .variable-value {
            font-size: 10px;
            color: var(--muted);
            font-family: 'SF Mono', Monaco, monospace;
        }

        .item-actions {
            display: flex;
            gap: 4px;
        }

        .action-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 3px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .collection-item:hover .action-btn,
        .variable-item:hover .action-btn {
            opacity: 1;
        }

        .action-btn:hover {
            background: var(--border);
        }

        .loading-state, .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: var(--muted);
            font-size: 11px;
            text-align: center;
            height: 80px;
        }

        .loading-state .loading {
            margin-bottom: 8px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--panel-strong);
            border-radius: 8px;
            padding: 20px;
            width: 280px;
            max-width: 90vw;
        }

        .modal-header {
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .modal-description {
            font-size: 11px;
            color: var(--muted);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
            background: var(--panel-strong);
            color: var(--text);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .color-input {
            width: 60px;
            height: 32px;
            padding: 0;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .modal-actions .button {
            margin-bottom: 0;
            padding: 8px 16px;
            width: auto;
        }

        /* Fixed Action Bar with Glassmorphism */
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.06);
            z-index: 1000;
        }

        [data-theme="dark"] .action-bar {
            background: rgba(15, 17, 21, 0.85);
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.3);
        }

        .action-bar .button {
            margin-bottom: 0;
        }

        .action-bar-content {
            display: none;
        }

        .action-bar-content.active {
            display: block;
        }

        /* Tooltip Styles */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 4px;
            vertical-align: middle;
        }

        .tooltip-icon {
            width: 14px;
            height: 14px;
            display: inline-block;
            color: var(--muted);
            transition: color 0.2s ease;
        }

        .tooltip:hover .tooltip-icon {
            color: var(--accent);
        }

        .tooltip-text {
            visibility: hidden;
            opacity: 0;
            width: 280px;
            background-color: var(--panel-strong);
            color: var(--text);
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            font-size: 11px;
            line-height: 1.5;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        [data-theme="dark"] .tooltip-text {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--border) transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-text strong {
            color: var(--accent);
            display: block;
            margin-bottom: 4px;
        }

        .tooltip-text ul {
            margin: 8px 0 8px 16px;
            padding: 0;
        }

        .tooltip-text li {
            margin: 4px 0;
        }

        /* SVG Icon Styles */
        .icon-svg {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
            fill: currentColor;
        }

        .button .icon-svg {
            margin-right: 6px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-row">
            <div>
                <h1>Design Tokens Manager</h1>
                <p>Manage, convert, and export Figma design tokens</p>
            </div>
            <div class="header-actions">
                <button id="theme-toggle" class="icon-button" aria-label="Toggle theme">
                    <svg id="theme-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Sun icon (shown in dark mode) -->
                        <g id="sun-icon">
                            <circle cx="8" cy="8" r="3" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M8 1V2M8 14V15M15 8H14M2 8H1M12.5 3.5L11.8 4.2M4.2 11.8L3.5 12.5M12.5 12.5L11.8 11.8M4.2 4.2L3.5 3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </g>
                        <!-- Moon icon (shown in light mode) -->
                        <g id="moon-icon" style="display: none;">
                            <path d="M14 8.5C14 11.5376 11.5376 14 8.5 14C5.46243 14 3 11.5376 3 8.5C3 5.46243 5.46243 3 8.5 3C8.67044 3 8.83923 3.00767 9.00598 3.02264C7.84897 3.86687 7.09091 5.21295 7.09091 6.72727C7.09091 9.24343 9.12111 11.2727 11.6364 11.2727C12.5455 11.2727 13.3923 11.0228 14.1095 10.5909C14.0369 10.8866 13.9473 11.1758 13.8416 11.4569C13.3193 10.5444 12.4725 9.84848 11.4545 9.54545" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </g>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div id="status-message" class="status status-info">Ready to process variables</div>

    <div class="tabs">
        <button class="tab active" data-tab="design-tokens" data-step="1">Design Tokens</button>
        <button class="tab" data-tab="converter" data-step="2">Converter</button>
        <button class="tab" data-tab="exporter" data-step="3">Exporter</button>
    </div>

    <div class="tab-content">

        <!-- Design Tokens Tab -->
        <div id="design-tokens" class="tab-panel active">
            <div class="section">
                <h2>
                    <svg class="icon-svg" style="vertical-align: middle; margin-right: 6px;" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="2" y="2" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        <rect x="9" y="2" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        <rect x="2" y="9" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        <rect x="9" y="9" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    Variable Collections
                </h2>
                <div id="collections-list" class="collections-container">
                    <div class="loading-state">
                        <div class="loading"></div>
                        <span>Loading collections...</span>
                    </div>
                </div>
                <div class="info-message">
                    Create collections manually in Figma UI to see them here
                </div>
            </div>

            <div class="section">
                <h2>
                    <svg class="icon-svg" style="vertical-align: middle; margin-right: 6px;" viewBox="0 0 640 640" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M392.8 65.2C375.8 60.3 358.1 70.2 353.2 87.2L225.2 535.2C220.3 552.2 230.2 569.9 247.2 574.8C264.2 579.7 281.9 569.8 286.8 552.8L414.8 104.8C419.7 87.8 409.8 70.1 392.8 65.2zM457.4 201.3C444.9 213.8 444.9 234.1 457.4 246.6L530.8 320L457.4 393.4C444.9 405.9 444.9 426.2 457.4 438.7C469.9 451.2 490.2 451.2 502.7 438.7L598.7 342.7C611.2 330.2 611.2 309.9 598.7 297.4L502.7 201.4C490.2 188.9 469.9 188.9 457.4 201.4zM182.7 201.3C170.2 188.8 149.9 188.8 137.4 201.3L41.4 297.3C28.9 309.8 28.9 330.1 41.4 342.6L137.4 438.6C149.9 451.1 170.2 451.1 182.7 438.6C195.2 426.1 195.2 405.8 182.7 393.3L109.3 320L182.6 246.6C195.1 234.1 195.1 213.8 182.6 201.3z" fill="currentColor"/>
                    </svg>
                    Variables
                </h2>
                <div id="variables-list" class="variables-container">
                    <div class="empty-state">Select a collection to view variables</div>
                </div>
                <div class="info-message">
                    Create variables manually in Figma UI to see them here
                </div>
            </div>
        </div>

        <!-- Converter Tab -->
        <div id="converter" class="tab-panel">
            <div class="section">
                <h2>
                    <svg class="icon-svg" style="vertical-align: middle; margin-right: 6px;" viewBox="0 0 640 640" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M128.5 64C93.2 64 64.5 92.7 64.5 128L64.5 512C64.5 547.3 93.2 576 128.5 576L384.5 576C419.8 576 448.5 547.3 448.5 512L448.5 416L526.6 416L495.6 447C486.2 456.4 486.2 471.6 495.6 480.9C505 490.2 520.2 490.3 529.5 480.9L601.5 408.9C610.9 399.5 610.9 384.3 601.5 375L529.5 303C520.1 293.6 504.9 293.6 495.6 303C486.3 312.4 486.2 327.6 495.6 336.9L526.6 367.9L448.5 367.9L448.5 234.4C448.5 217.4 441.8 201.1 429.8 189.1L323.2 82.7C311.2 70.7 295 64 278 64L128.5 64zM390 240L296.5 240C283.2 240 272.5 229.3 272.5 216L272.5 122.5L390 240zM256.5 392C256.5 378.7 267.2 368 280.5 368L384.5 368L384.5 416L280.5 416C267.2 416 256.5 405.3 256.5 392z" fill="currentColor"/>
                    </svg>
                    Convert Variables
                </h2>
                <p style="font-size: 11px; color: #8c8c8c; margin-bottom: 12px;">
                    Updates Figma web devmode with CSS variable names
                </p>
                <div id="variables-count" class="variables-count hidden"></div>
            </div>
        </div>

        <!-- Exporter Tab -->
        <div id="exporter" class="tab-panel">
            <div class="section">
                <h2>
                    <svg class="icon-svg" style="vertical-align: middle; margin-right: 6px;" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M357.728 949.888c30.976 0 39.744-12.128 39.744-27.616s0-49.184-0.672-97.024c-160.992 34.368-195.36-76.8-195.36-76.8-26.272-65.344-64.672-83.552-64.672-83.552-52.544-35.040 4.032-34.368 4.032-34.368 57.952 4.032 88.928 58.624 88.928 58.624 51.872 87.584 135.424 62.016 168.416 47.168 2.688-28.96 15.488-56.576 37.056-76.8-128.672-14.144-264.096-63.328-264.096-281.6-0.672-56.576 20.896-111.84 59.968-152.928-6.752-14.144-26.272-72.096 4.704-150.912 0 0 48.512-15.488 159.648 58.624 94.976-25.6 194.688-25.6 289.696 0 109.824-73.44 158.976-58.624 158.976-58.624 30.976 78.144 11.456 136.096 6.048 150.912 39.072 41.088 59.968 96.352 59.296 152.928 0 218.944-135.424 266.784-264.768 280.928 20.224 16.832 39.072 51.872 39.072 105.088 0 76.8-0.672 137.44-0.672 155.616 0 14.816 6.752 26.944 39.744 26.944z" fill="currentColor"/>
                    </svg>
                    Export to GitHub
                </h2>
                <p style="font-size: 11px; color: #8c8c8c; margin-bottom: 12px;">
                    Configure repository and export design tokens. Settings are stored locally.
                </p>

                <div class="form-group">
                    <label class="form-label" for="gh-owner">GitHub Organization or Username</label>
                    <input id="gh-owner" class="form-input" type="text" placeholder="e.g. johndoe" />
                </div>
                <div class="form-group">
                    <label class="form-label" for="gh-repo">Repository Name</label>
                    <input id="gh-repo" class="form-input" type="text" placeholder="e.g. design-tokens" />
                </div>
                <div class="form-group">
                    <label class="form-label" for="gh-path">Folder Path in Repository</label>
                    <input id="gh-path" class="form-input" type="text" placeholder="e.g. src/tokens (files will be created per theme)" />
                </div>
                <div class="form-group">
                    <label class="form-label" for="gh-token">
                        GitHub Access Token
                        <span class="tooltip">
                            <svg class="tooltip-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M8 7V11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <circle cx="8" cy="5" r="0.5" fill="currentColor"/>
                            </svg>
                            <span class="tooltip-text">
                                <strong>Required Token Permissions:</strong>
                                Create a Personal Access Token at:<br>
                                <code>github.com/settings/tokens/new</code>
                                <ul>
                                    <li><strong>repo</strong> - Full control of private repositories (required for creating branches, committing files)</li>
                                    <li><strong>workflow</strong> - Update GitHub Actions (optional but recommended)</li>
                                </ul>
                                The plugin needs these permissions to:
                                <ul>
                                    <li>Create feature branches</li>
                                    <li>Commit CSS files</li>
                                    <li>Access repository contents</li>
                                </ul>
                            </span>
                        </span>
                    </label>
                    <input id="gh-token" class="form-input" type="password" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="off" />
                </div>

                <div id="config-status" class="hidden" style="font-size: 10px; color: var(--muted); margin-top: 8px; margin-bottom: 16px; text-align: center;">
                    Settings are saved locally and sent to the plugin for this session.
                </div>
                <div id="export-status" class="hidden" style="font-size: 10px; color: #8c8c8c; margin-top: 8px; text-align: center;">
                    Convert variables first to enable export
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Action Bar -->
    <div class="action-bar">
        <!-- Design Tokens Actions -->
        <div id="action-design-tokens" class="action-bar-content active">
            <p style="font-size: 10px; color: var(--muted); text-align: center; margin-bottom: 8px;">
                View and manage your Figma design token collections
            </p>
        </div>

        <!-- Converter Actions -->
        <div id="action-converter" class="action-bar-content">
            <button id="convert-btn" class="button button-primary">
                <svg class="icon-svg" viewBox="0 0 640 640" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M128.5 64C93.2 64 64.5 92.7 64.5 128L64.5 512C64.5 547.3 93.2 576 128.5 576L384.5 576C419.8 576 448.5 547.3 448.5 512L448.5 416L526.6 416L495.6 447C486.2 456.4 486.2 471.6 495.6 480.9C505 490.2 520.2 490.3 529.5 480.9L601.5 408.9C610.9 399.5 610.9 384.3 601.5 375L529.5 303C520.1 293.6 504.9 293.6 495.6 303C486.3 312.4 486.2 327.6 495.6 336.9L526.6 367.9L448.5 367.9L448.5 234.4C448.5 217.4 441.8 201.1 429.8 189.1L323.2 82.7C311.2 70.7 295 64 278 64L128.5 64zM390 240L296.5 240C283.2 240 272.5 229.3 272.5 216L272.5 122.5L390 240zM256.5 392C256.5 378.7 267.2 368 280.5 368L384.5 368L384.5 416L280.5 416C267.2 416 256.5 405.3 256.5 392z" fill="currentColor"/>
                </svg>
                Convert Variables to Dev Format
            </button>
        </div>

        <!-- Exporter Actions -->
        <div id="action-exporter" class="action-bar-content">
            <button id="save-config-btn" class="button button-secondary" style="margin-bottom: 8px;">
                <svg class="icon-svg" viewBox="0 0 640 640" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M160 96C124.7 96 96 124.7 96 160L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 237.3C544 220.3 537.3 204 525.3 192L448 114.7C436 102.7 419.7 96 402.7 96L160 96zM192 192C192 174.3 206.3 160 224 160L384 160C401.7 160 416 174.3 416 192L416 256C416 273.7 401.7 288 384 288L224 288C206.3 288 192 273.7 192 256L192 192zM320 352C355.3 352 384 380.7 384 416C384 451.3 355.3 480 320 480C284.7 480 256 451.3 256 416C256 380.7 284.7 352 320 352z" fill="currentColor"/>
                </svg>
                Save Settings
            </button>
            <button id="export-btn" class="button button-primary" disabled>
                <svg class="icon-svg" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M357.728 949.888c30.976 0 39.744-12.128 39.744-27.616s0-49.184-0.672-97.024c-160.992 34.368-195.36-76.8-195.36-76.8-26.272-65.344-64.672-83.552-64.672-83.552-52.544-35.040 4.032-34.368 4.032-34.368 57.952 4.032 88.928 58.624 88.928 58.624 51.872 87.584 135.424 62.016 168.416 47.168 2.688-28.96 15.488-56.576 37.056-76.8-128.672-14.144-264.096-63.328-264.096-281.6-0.672-56.576 20.896-111.84 59.968-152.928-6.752-14.144-26.272-72.096 4.704-150.912 0 0 48.512-15.488 159.648 58.624 94.976-25.6 194.688-25.6 289.696 0 109.824-73.44 158.976-58.624 158.976-58.624 30.976 78.144 11.456 136.096 6.048 150.912 39.072 41.088 59.968 96.352 59.296 152.928 0 218.944-135.424 266.784-264.768 280.928 20.224 16.832 39.072 51.872 39.072 105.088 0 76.8-0.672 137.44-0.672 155.616 0 14.816 6.752 26.944 39.744 26.944z" fill="currentColor"/>
                </svg>
                Export CSS to GitHub
            </button>
        </div>
    </div>


    <script>
        // DOM Elements
        const tabs = document.querySelectorAll('.tab');
        const tabPanels = document.querySelectorAll('.tab-panel');
        const statusMessage = document.getElementById('status-message');
        
        // Design Tokens Tab Elements
        const collectionsContainer = document.getElementById('collections-list');
        const variablesContainer = document.getElementById('variables-list');
        
        // Converter Tab Elements
        const convertBtn = document.getElementById('convert-btn');
        const variablesCount = document.getElementById('variables-count');
        
        // Exporter Tab Elements
        const exportBtn = document.getElementById('export-btn');
        const exportStatus = document.getElementById('export-status');
        const themeToggle = document.getElementById('theme-toggle');
        const ghOwnerInput = document.getElementById('gh-owner');
        const ghRepoInput = document.getElementById('gh-repo');
        const ghPathInput = document.getElementById('gh-path');
        const ghTokenInput = document.getElementById('gh-token');
        const saveConfigBtn = document.getElementById('save-config-btn');
        const configStatus = document.getElementById('config-status');
        
        // Theme management
        const THEME_STORAGE_KEY = 'figma-tokens-theme';
        const GITHUB_STORAGE_KEY = 'figma-tokens-github-config';
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
        let savedTheme = null;
        let githubConfig = null;
        
        function getStoredTheme() {
            try {
                return localStorage.getItem(THEME_STORAGE_KEY);
            } catch (e) {
                return null;
            }
        }

        function storeTheme(theme) {
            try {
                localStorage.setItem(THEME_STORAGE_KEY, theme);
            } catch (e) {
                // ignore storage issues
            }
        }

        function clearStoredTheme() {
            try {
                localStorage.removeItem(THEME_STORAGE_KEY);
            } catch (e) {
                // ignore storage issues
            }
        }

        function applyTheme(theme, persist = false) {
            document.documentElement.setAttribute('data-theme', theme);

            // Toggle sun/moon icons
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            if (theme === 'dark') {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            } else {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            }

            themeToggle.setAttribute('aria-label', `Switch to ${theme === 'dark' ? 'light' : 'dark'} mode`);
            if (persist) {
                storeTheme(theme);
                savedTheme = theme;
            }
        }

        function resolveInitialTheme() {
            savedTheme = getStoredTheme();
            if (savedTheme) {
                return savedTheme;
            }
            return prefersDark.matches ? 'dark' : 'light';
        }

        function handleSystemThemeChange(event) {
            if (savedTheme) return; // user preference wins
            applyTheme(event.matches ? 'dark' : 'light', false);
        }

        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme') || resolveInitialTheme();
            const nextTheme = current === 'dark' ? 'light' : 'dark';
            applyTheme(nextTheme, true);
        });

        prefersDark.addEventListener('change', handleSystemThemeChange);
        applyTheme(resolveInitialTheme());

        // Load and apply stored GitHub config, then send to plugin
        githubConfig = loadStoredGithubConfig();
        applyGithubConfigToInputs(githubConfig);
        if (githubConfig) {
          sendGithubConfigToPlugin(githubConfig);
          configStatus.classList.remove('hidden');
          configStatus.textContent = 'Loaded saved GitHub settings.';
        }

        saveConfigBtn.addEventListener('click', () => {
          const cfg = buildGithubConfigFromInputs();
          if (!isGithubConfigComplete(cfg)) {
            showStatus('Please fill all GitHub settings before saving.', 'error');
            return;
          }
          persistGithubConfig(cfg);
          sendGithubConfigToPlugin(cfg);
          configStatus.classList.remove('hidden');
          configStatus.textContent = 'Settings saved locally and applied to this session.';
          showStatus('GitHub settings saved', 'success');
        });

        // GitHub config helpers
        function loadStoredGithubConfig() {
          try {
            const raw = localStorage.getItem(GITHUB_STORAGE_KEY);
            return raw ? JSON.parse(raw) : null;
          } catch (e) {
            return null;
          }
        }

        function persistGithubConfig(cfg) {
          githubConfig = cfg;
          try {
            localStorage.setItem(GITHUB_STORAGE_KEY, JSON.stringify(cfg));
          } catch (e) {
            // ignore storage errors
          }
        }

        function applyGithubConfigToInputs(cfg) {
          if (!cfg) return;
          ghOwnerInput.value = cfg.owner || '';
          ghRepoInput.value = cfg.repo || '';
          ghPathInput.value = cfg.path || '';
          ghTokenInput.value = cfg.token || '';
        }

        function sendGithubConfigToPlugin(cfg) {
          parent.postMessage({
            pluginMessage: {
              type: 'update-config',
              githubConfig: cfg,
            }
          }, '*');
        }

        function buildGithubConfigFromInputs() {
          return {
            owner: ghOwnerInput.value.trim(),
            repo: ghRepoInput.value.trim(),
            path: ghPathInput.value.trim(),
            token: ghTokenInput.value.trim(),
          };
        }

        function isGithubConfigComplete(cfg) {
          return !!(cfg && cfg.owner && cfg.repo && cfg.path && cfg.token);
        }
        
        // Global State
        let collections = [];
        let selectedCollection = null;
        let variables = [];
        let convertedVariables = null;
        let editorType = 'figma'; // Default to figma editor

        // Utility Functions
        function showStatus(message, type = 'info') {
            statusMessage.className = `status status-${type}`;
            statusMessage.textContent = message;
        }

        function hideStatus() {
            // Keep status visible with default message
            statusMessage.className = 'status status-info';
            statusMessage.textContent = 'Ready to process variables';
        }

        function setButtonLoading(button, loading, loadingText) {
            if (loading) {
                button.innerHTML = `<span class="loading"></span> ${loadingText}`;
                button.disabled = true;
            } else {
                resetButtonContent(button);
                button.disabled = false;
            }
        }

        function resetButtonContent(button) {
            const buttonConfigs = {
                'convert-btn': '<svg class="icon-svg" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 8C14 8 12.5 10.5 8 10.5C3.5 10.5 2 8 2 8C2 8 3.5 5.5 8 5.5C12.5 5.5 14 8 14 8Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 2L14 14M4 13L3 14M12 13L13 14M12 3L13 2M4 3L3 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><circle cx="8" cy="8" r="2" stroke="currentColor" stroke-width="1.5"/></svg> Convert Variables to Dev Format',
                'export-btn': '<svg class="icon-svg" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 1V10M8 10L11 7M8 10L5 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 10V14C14 14.5523 13.5523 15 13 15H3C2.44772 15 2 14.5523 2 14V10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg> Export CSS to GitHub'
            };
            button.innerHTML = buttonConfigs[button.id] || button.innerHTML;
        }

        // Tab Management
        function switchTab(targetTab) {
            tabs.forEach(tab => tab.classList.remove('active'));
            tabPanels.forEach(panel => panel.classList.remove('active'));

            const targetTabElement = document.querySelector(`[data-tab="${targetTab}"]`);
            const targetPanelElement = document.getElementById(targetTab);

            if (targetTabElement) {
                targetTabElement.classList.add('active');
            }

            if (targetPanelElement) {
                targetPanelElement.classList.add('active');
            }

            // Update action bar to show relevant actions
            const actionBarContents = document.querySelectorAll('.action-bar-content');
            actionBarContents.forEach(content => content.classList.remove('active'));
            const activeActionBar = document.getElementById(`action-${targetTab}`);
            if (activeActionBar) {
                activeActionBar.classList.add('active');
            }

            // Load data for Design Tokens tab
            if (targetTab === 'design-tokens') {
                loadCollections();
            }
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.getAttribute('data-tab');
                switchTab(targetTab);
            });
        });

        // Design Tokens Management
        function loadCollections() {
            collectionsContainer.innerHTML = '<div class="loading-state"><div class="loading"></div><span>Loading collections...</span></div>';
            
            parent.postMessage({ 
                pluginMessage: { 
                    type: 'load-collections' 
                } 
            }, '*');
        }

        function renderCollections(collectionsData) {
            collections = collectionsData;
            
            if (collections.length === 0) {
                collectionsContainer.innerHTML = '<div class="empty-state">No collections found<br><small>Create your first collection to get started</small></div>';
                return;
            }

            collectionsContainer.innerHTML = collections.map(collection => `
                <div class="collection-item" data-collection-id="${collection.id}">
                    <div>
                        <div class="collection-name">${collection.name}</div>
                        <div class="collection-meta">${collection.variableCount || 0} variables</div>
                    </div>
                </div>
            `).join('');

            // Add click handlers for collection selection
            document.querySelectorAll('.collection-item').forEach(item => {
                item.addEventListener('click', () => {
                    selectCollection(item.dataset.collectionId);
                });
            });
        }

        function selectCollection(collectionId) {
            selectedCollection = collections.find(c => c.id === collectionId);
            
            // Update UI selection
            document.querySelectorAll('.collection-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-collection-id="${collectionId}"]`).classList.add('selected');
            
            // Load variables for this collection
            loadVariables(collectionId);
        }

        function loadVariables(collectionId) {
            variablesContainer.innerHTML = '<div class="loading-state"><div class="loading"></div><span>Loading variables...</span></div>';
            
            parent.postMessage({ 
                pluginMessage: { 
                    type: 'load-variables',
                    collectionId: collectionId
                } 
            }, '*');
        }

        function renderVariables(variablesData) {
            variables = variablesData;
            
            if (variables.length === 0) {
                variablesContainer.innerHTML = '<div class="empty-state">No variables in this collection<br><small>Add your first variable</small></div>';
                return;
            }

            variablesContainer.innerHTML = variables.map(variable => `
                <div class="variable-item" data-variable-id="${variable.id}">
                    <div>
                        <div class="variable-name">${variable.name}</div>
                        <div class="variable-value">${formatVariableValue(variable)}</div>
                        <div class="variable-meta">${variable.resolvedType}</div>
                    </div>
                </div>
            `).join('');
        }

        function formatVariableValue(variable) {
            if (!variable.valuesByMode || Object.keys(variable.valuesByMode).length === 0) {
                return 'No value';
            }
            
            const firstMode = Object.keys(variable.valuesByMode)[0];
            const value = variable.valuesByMode[firstMode];
            
            switch (variable.resolvedType) {
                case 'COLOR':
                    if (value.type === 'VARIABLE_ALIAS') {
                        return `‚Üí ${value.id}`;
                    }
                    return `rgba(${Math.round(value.r * 255)}, ${Math.round(value.g * 255)}, ${Math.round(value.b * 255)}, ${value.a})`;
                case 'FLOAT':
                    return value.toString();
                case 'STRING':
                    return `"${value}"`;
                case 'BOOLEAN':
                    return value ? 'true' : 'false';
                default:
                    return String(value);
            }
        }



        // Converter Tab Logic (existing functionality)
        convertBtn.addEventListener('click', async () => {
            hideStatus();
            setButtonLoading(convertBtn, true, 'Converting...');
            variablesCount.classList.add('hidden');

            try {
                parent.postMessage({ 
                    pluginMessage: { 
                        type: 'convert-variables' 
                    } 
                }, '*');
            } catch (error) {
                showStatus('Failed to start conversion', 'error');
                setButtonLoading(convertBtn, false);
            }
        });

        // Exporter Tab Logic (existing functionality)
        exportBtn.addEventListener('click', async () => {
            if (!convertedVariables) {
                showStatus('Convert variables first', 'error');
                return;
            }

            const cfg = buildGithubConfigFromInputs();
            if (!isGithubConfigComplete(cfg)) {
                showStatus('Fill GitHub settings in Settings tab before exporting.', 'error');
                return;
            }
            persistGithubConfig(cfg);
            sendGithubConfigToPlugin(cfg);

            hideStatus();
            setButtonLoading(exportBtn, true, 'Exporting...');

            try {
                parent.postMessage({ 
                    pluginMessage: { 
                        type: 'export-github',
                        variables: convertedVariables
                    } 
                }, '*');
            } catch (error) {
                showStatus('Failed to start export', 'error');
                setButtonLoading(exportBtn, false);
            }
        });

        // Configure UI based on editor type
        function configureUIForEditorType(type) {
            editorType = type;
            console.log('üé® Configuring UI for editor type:', type);

            if (type === 'dev') {
                // In dev mode, hide Design Tokens and Exporter tabs
                const designTokensTab = document.querySelector('[data-tab="design-tokens"]');
                const exporterTab = document.querySelector('[data-tab="exporter"]');
                const converterTab = document.querySelector('[data-tab="converter"]');

                if (designTokensTab) {
                    designTokensTab.style.display = 'none';
                    designTokensTab.classList.remove('active');
                }
                if (exporterTab) {
                    exporterTab.style.display = 'none';
                    exporterTab.classList.remove('active');
                }

                // Make converter tab active
                if (converterTab) {
                    converterTab.classList.add('active');
                }

                // Hide other tab panels and show converter
                const designTokensPanel = document.getElementById('design-tokens');
                const exporterPanel = document.getElementById('exporter');
                const converterPanel = document.getElementById('converter');

                if (designTokensPanel) designTokensPanel.classList.remove('active');
                if (exporterPanel) exporterPanel.classList.remove('active');
                if (converterPanel) converterPanel.classList.add('active');

                // Update action bar
                const actionBarContents = document.querySelectorAll('.action-bar-content');
                actionBarContents.forEach(content => content.classList.remove('active'));
                const converterActionBar = document.getElementById('action-converter');
                if (converterActionBar) converterActionBar.classList.add('active');

                console.log('‚úÖ Dev mode UI configured - showing only Converter tab');
            } else {
                // In figma editor, show all tabs
                const designTokensTab = document.querySelector('[data-tab="design-tokens"]');
                const exporterTab = document.querySelector('[data-tab="exporter"]');

                if (designTokensTab) designTokensTab.style.display = '';
                if (exporterTab) exporterTab.style.display = '';

                console.log('‚úÖ Figma editor UI configured - showing all tabs');
            }
        }

        // Message Handler
        window.addEventListener('message', (event) => {
            const { type, data } = event.data.pluginMessage || {};

            switch (type) {
                // Editor Type Configuration
                case 'editor-type':
                    configureUIForEditorType(data.editorType);
                    break;

                // Design Tokens Messages
                case 'collections-loaded':
                    renderCollections(data.collections);
                    break;
                
                case 'variables-loaded':
                    renderVariables(data.variables);
                    break;

                // Converter Messages (existing)
                case 'convert-success':
                    convertedVariables = data.variables;
                    showStatus(`‚úÖ Converted ${data.count} variables successfully`, 'success');
                    variablesCount.textContent = `${data.count} variables ready for export`;
                    variablesCount.classList.remove('hidden');
                    exportBtn.disabled = false;
                    exportBtn.classList.remove('button-secondary');
                    exportBtn.classList.add('button-primary');
                    exportStatus.classList.add('hidden');
                    setButtonLoading(convertBtn, false);
                    break;

                case 'convert-error':
                    showStatus(`‚ùå Conversion failed: ${data.message}`, 'error');
                    setButtonLoading(convertBtn, false);
                    break;

                // Exporter Messages (existing)
                case 'export-success':
                    showStatus(`‚úÖ Successfully exported to GitHub`, 'success');
                    setButtonLoading(exportBtn, false);
                    break;

                case 'export-error':
                    showStatus(`‚ùå Export failed: ${data.message}`, 'error');
                    setButtonLoading(exportBtn, false);
                    break;

                case 'config-updated':
                    configStatus.classList.remove('hidden');
                    configStatus.textContent = 'GitHub settings applied.';
                    break;

                // Generic Messages
                case 'status-update':
                    showStatus(data.message, data.type || 'info');
                    break;
                
                case 'error':
                    showStatus(`‚ùå ${data.message}`, 'error');
                    break;
            }
        });

        // Request editor type from plugin once UI is ready
        parent.postMessage({
            pluginMessage: {
                type: 'ui-ready'
            }
        }, '*');

        // Initialize the Design Tokens tab (will be skipped if in dev mode)
        // The configureUIForEditorType will be called when the plugin sends the editor-type message
        if (editorType !== 'dev') {
            loadCollections();
        }
    </script>
</body>
</html>
